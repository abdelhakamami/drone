kind: pipeline
type: kubernetes
name: default

steps:
- name: greeting
  image: alpine
  commands:
  - echo hello
- name: deploy
  image: bitnami/git:latest
  environment:
    ssh_key:
      from_secret: ssh
   
  commands:
    - mkdir -p /root/.ssh &&  chmod 700 /root/.ssh
    - touch ~/.ssh/id_rsa.pub
    - echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDWiwJvUNMWajAiX5xKuZmY+6gDaOQrBiHcciVU5U0o7U/cWC6S9lY3ehDIyrZm7y3LOMKAK0lUR0bPfe2xNUfhzHkNBnDT4VQa7D3697E1k93v8TDOf+CECBDpizPsIe3nlu+fvyF869FhLI5DQ8jPZrmI5ZXO4mSrvi6dcpYpkusBJYin9DKtLR9+Wd1ZFd6tdPY79MgkywOsP3OhXVcksoOCK+uXF/ICiTpGSvf5Tuwu0dl1RLQ87p6ZNwzEtkGDUeHo8eovLodGmqTS8uQDSeAlWR5SIf+1MLlw1vQd/VH4EJJ1KQMUPI9ljiS3YUuPdEfPYU5tUhFyjLR+bAeaGEM8IyN3iWlnOeWP1DWdAIjPEdhKPLmjAGuCiiLQII64G0CTpJUaWa9/AygNDYJvvoHZiBI35hoNs1cUOQQz6dUHdOiOub9o4oBLjgot9d9cr/Dr804hvB0bLnukn9xQK+1H8qKrMYeHOShLMzIn4QV7QGE43FXIUBblFc5PvrE= abdelhak@avaxia" >> ~/.ssh/id_rsa.pub 
    - git clone git@github.com:abdelhakamami/devops.git
    - git clone git@github.com:abdelhakamami/electionApp.git
    - cd electionApp && old=$(git rev-parse HEAD | cut -c 1-7
    
    - cd ..
    - cd devops/apps/election-app/
    - sed -i "s/$old/dev/g" kustomization.yaml 
    - git add . && git commit -m  "abc" && git push

    
    

    
  
